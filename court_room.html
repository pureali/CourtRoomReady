<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Virtual Court Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: url('images/civil-court-bg.webp') center center/cover no-repeat fixed;
            position: relative;
        }
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(30,40,70,0.65);
            z-index: 0;
        }
        .court-title-bar {
            width: 100vw;
            background: #000;
            color: #fff;
            padding: 18px 0 14px 0;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        }
        .court-layout {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-top: 80px; /* space for title bar */
        }
        .judge-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 48px;
            position: relative;
        }
        .judge-box {
            background: rgba(44,62,80,0.95);
            border-radius: 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 24px 24px 18px 24px;
            text-align: center;
            width: 450px;
            height: 450px;
            border: 2px solid #e8d5b7;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .judge-title {
            display: none; /* moved to top bar */
        }
        .judge-avatar {
           
            width: 440px;
            height: 440px;
            border-radius: 12px;
            background: #fff;
            margin: 0 auto 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }
        .judge-avatar img, .judge-avatar video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .bottom-section {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 48px;
        }
        .court-box {
            background: rgba(44,62,80,0.93);
            border-radius: 14px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.12);
            padding: 5px; /* Reduced padding */
            width: 310px;
            min-height: 310px;
            text-align: center;
            border: 2px solid #2d5be3;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.18rem;
        }
        .court-box-title {
            font-size: 1rem; /* Reduced font size */
            font-weight: 600;
            color: #fff;
            background: #000;
            padding: 6px 0;
            border-radius: 6px;
            margin-bottom: 10px;
            width: 100%;
        }
        .user-video, .avatar-placeholder {
            width: 300px;
            height: 300px;
            border-radius: 12px;
            background: #222b3a;
            margin-bottom: 12px;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            font-size: 2.2rem;
        }
        .avatar-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e8d5b7;
            font-size: 2.8rem;
            background: #1a233a;
            overflow: hidden;
        }
        .start-btn-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30,40,70,0.85);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .start-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 22px 60px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 16px rgba(0,0,0,0.18);
            transition: background 0.2s;
        }
        .start-btn:hover {
            background: #219150;
        }
        @media (max-width: 900px) {
            .judge-box { width: 40vw; min-width: 140px; }
            .bottom-section { gap: 12px; }
            .court-box { width: 30vw; min-width: 140px; }
        }
        .chatbot-panel {
            background: rgba(44,62,80,0.95);
            border-radius: 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 20px;
            width: 350px;
            height: 450px;
            border: 2px solid #e8d5b7;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-left: 20px;
        }
        .chatbot-header {
            background: #2d5be3;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30,40,70,0.3);
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 300px;
        }
        .chatbot-message {
            background: rgba(45, 85, 255, 0.2);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #2d5be3;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #ffffff;
        }
        .chatbot-suggestion {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
            color: #ffffff;
        }
        .chatbot-warning {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            color: #ffffff;
        }
        .chatbot-input {
            display: flex;
            gap: 8px;
        }
        .chatbot-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 6px;
            background: rgba(30,40,70,0.5);
            color: #fff;
            font-size: 0.9rem;
        }
        .chatbot-input input::placeholder {
            color: #aaa;
        }
        .chatbot-send-btn {
            background: #2d5be3;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .chatbot-send-btn:hover {
            background: #1e3a8a;
        }
        .chatbot-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        @media (max-width: 1200px) {
            .judge-section {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .chatbot-panel {
                width: 450px;
                height: 300px;
                margin-left: 0;
            }
        }
        @media (max-width: 600px) {
            .court-title-bar { font-size: 1.2rem; padding: 14px 0 10px 0; }
            .judge-section { margin-top: 24px; }
            .bottom-section { flex-direction: column; align-items: center; gap: 18px; margin-bottom: 24px; }
            .court-box { width: 80vw; }
            .judge-box { width: 80vw; }
            .chatbot-panel { width: 80vw; height: 250px; }
        }
    </style>
</head>
<body>
    <div class="court-title-bar">Virtual Court Room</div>
    <div class="overlay"></div>
    <div id="talkingStatusContainer" style="width:100vw; text-align:center; margin-top:80px; margin-bottom:-60px; z-index:3; position:relative;">
        <div id="judgeTalkingStatus" style="display:inline-block; background:#222; color:#fff; padding:8px 24px; border-radius:8px; margin-right:12px; font-size:1.1rem;">
            Judge is silent
        </div>
        <div id="councellorTalkingStatus" style="display:inline-block; background:#222; color:#fff; padding:8px 24px; border-radius:8px; font-size:1.1rem;">
            Counsellor is silent
        </div>
    </div>
    <div class="court-layout">
        <div class="judge-section">
            <div class="judge-box">
                <div class="court-box-title">Judge</div>
                <div class="judge-avatar">                    
                    <video id="persona-video" autoplay playsinline style="display:block;"></video>
                </div>
                <div id="status" style="margin-top: 10px; font-size: 14px; color: #666;">Loading...</div>
                
            </div>
            <div class="chatbot-panel">
                <div class="chatbot-status"></div>
                <div class="chatbot-header">Legal Assistant</div>
                <div class="chatbot-messages" id="chatbotMessages">
                    <div class="chatbot-message">
                        Welcome! I'm tracking both the judge and opposing counsel. I'll analyze their statements and provide strategic legal suggestions to help you respond effectively.
                    </div>
                </div>
                <div class="chatbot-input">
                    <input type="text" id="chatbotInput" placeholder="Ask for legal advice..." />
                    <button class="chatbot-send-btn" id="chatbotSendBtn">Send</button>
                </div>
            </div>
        </div>
        <div class="bottom-section">
            <div class="court-box" id="user-box">
                <div class="court-box-title">You</div>
                <video id="userVideo" class="user-video" autoplay muted playsinline></video>
                
            </div>
            <div class="court-box">
                <div class="court-box-title">Opposing Counsellor</div>
                <div class="avatar-placeholder">
                    <video id="councellor-video" autoplay playsinline style="display:block;"></video>
                </div>
                
            </div>
            <!-- <div class="court-box">
                <div class="court-box-title">Witness</div>
                <div class="avatar-placeholder">üßë‚Äç‚öñÔ∏è</div>
                
            </div> -->
        </div>
    </div>
    <div class="start-btn-container" id="startBtnContainer">
        <button class="start-btn" id="startBtn">Start Court Proceedings</button>
    </div>
    <div class="court-controls" style="width:100%; text-align:center; margin:30px 0 20px 0;">
        <button id="playBtn" style="background:#2d5be3;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-right:16px;">Run</button>
        <button id="stopBtn" style="background:#c0392b;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-right:16px;">Stop</button>
        <button id="smileBtn" style="background:#c0392b;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-right:16px;">Smile</button>
        
        <!-- Video Analysis Controls -->
        <button id="startAnalysisBtn" style="background:#27ae60;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-right:16px;">Start Analysis</button>
        <button id="stopAnalysisBtn" style="background:#e74c3c;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-right:16px;">Stop Analysis</button>
        <button id="summaryBtn" style="background:#3498db;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:1.1rem;font-weight:bold;cursor:pointer;">Summary</button>
    </div>
    <script>
    // Import needed functions at top level
    // import { startChat, stopStreaming, sendUserMessage, eventMessageHistoryUpdated, stopCurrentGeneration, messageEventReceived } from './judge.js';
    // import { startChatCouncellor, stopStreamingCouncellor, sendUserMessageCouncellor, stopCurrentGenerationCouncellor, muteAudioCouncellor, messageEventReceivedCouncellor } from './councellor.js';
        
     var turn="judge";
    //  async function eventJudgeTalking(event){
    //     Console.log 
    //     if(turn==="judge"){
            
    //         await stopCurrentGenerationCouncellor();
    //         turn="councellor";
             
    //         // Handle judge talking event
    //      }else{
    //         turn="judge";
    //         await stopCurrentGeneration();

    //      }
    //  }
    //  async function eventCouncellorTalking(event){
    //      if(turn==="councellor"){
    //          // Handle councellor talking event
    //      }
    //  }
    //  function switchTurn(){
    //     if(turn==="judge"){
    //         turn="councellor";
    //     }else{
    //         turn="judge";
    //     }
    //  }
    </script>
    <script type="module">
        import { startChat,muteAudio, stopStreaming,sendUserMessage,eventMessageHistoryUpdated,stopCurrentGeneration, messageEventReceived } from './judge.js';
        import { startChatCouncellor, stopStreamingCouncellor, sendUserMessageCouncellor, stopCurrentGenerationCouncellor, muteAudioCouncellor, messageEventReceivedCouncellor } from './councellor.js';
    
        function setTalkingStatus(role, isTalking) {
            if (role === "judge") {
                document.getElementById("judgeTalkingStatus").textContent = isTalking ? "Judge is talking" : "Judge is silent";
            } else if (role === "councellor") {
                document.getElementById("councellorTalkingStatus").textContent = isTalking ? "Counsellor is talking" : "Counsellor is silent";
            }
        }

        async function messageHistoryJudgeUpdated(messages) {
            console.log('Judge Updated Messages:', messages);
            
            // Send the latest judge message to the chatbot for analysis
            if (messages && messages.length > 0) {
                const latestMessage = messages[messages.length - 1];
                if (window.legalAssistant && typeof latestMessage === 'string') {
                    window.legalAssistant.onJudgeMessage(latestMessage, 'judge');
                }
            }
            
            if (messages && messages.length > 0 && messages[messages.length - 1].toLowerCase().includes("case started")) {
                await stopCurrentGeneration();
                await muteAudio(true);
                await sendUserMessageCouncellor("The case has started. Speak now.");
            }
        }

        async function eventJudgeTalking(event){
            setTalkingStatus("judge", true);
            setTalkingStatus("councellor", false);
            
            if(turn==="judge"){
                await stopCurrentGenerationCouncellor();
                turn="councellor";
            }else{
                turn="judge";
                //await stopCurrentGeneration();
            }
        }
        async function eventCouncellorTalking(event){
            setTalkingStatus("judge", false);
            setTalkingStatus("councellor", true);
            
            if(turn==="councellor"){
                await stopCurrentGeneration();
            }
        }

        // Function to track counsellor messages
        async function messageHistoryCounsellorUpdated(messages) {
            console.log('Counsellor Updated Messages:', messages);
            
            // Send the latest counsellor message to the chatbot for analysis
            if (messages && messages.length > 0) {
                const latestMessage = messages[messages.length - 1];
                if (window.legalAssistant && typeof latestMessage === 'string') {
                    window.legalAssistant.onJudgeMessage(latestMessage, 'counsellor');
                }
            }
        }

        document.getElementById('playBtn').onclick = async () => {
            await startChat("persona-video");
            //await muteAudioCouncellor(true);
            await startChatCouncellor("councellor-video");
            await stopCurrentGenerationCouncellor();
            await eventMessageHistoryUpdated(messageHistoryJudgeUpdated);
            await messageEventReceived(eventJudgeTalking);
            await messageEventReceivedCouncellor(eventCouncellorTalking);
            
            // Set up counsellor message tracking if available
            if (typeof eventMessageHistoryUpdatedCouncellor !== 'undefined') {
                await eventMessageHistoryUpdatedCouncellor(messageHistoryCounsellorUpdated);
            }
        };
        document.getElementById('stopBtn').onclick = () => {
            stopStreaming();
            stopStreamingCouncellor();
            setTalkingStatus("judge", false);
            setTalkingStatus("councellor", false);
        };
        document.getElementById('smileBtn').onclick = () => {
            sendUserMessage("Note to AI: show angry and frustration face without saying anything");
        };
    </script>
    <script>
        document.getElementById('startBtn').onclick = function() {
            // Hide start button and overlay background
            document.getElementById('startBtnContainer').style.display = 'none';
            document.querySelector('.overlay').style.display = 'none';
            // Start user webcam
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    const video = document.getElementById('userVideo');
                    video.srcObject = stream;
                })
                .catch(() => {
                    document.getElementById('user-box').innerHTML += '<div style="color:#ffb4b4;">Unable to access camera.</div>';
                });
        }
        
        // Add analysis button handlers
        document.getElementById('startAnalysisBtn').onclick = function() {
            if (window.videoAnalyzer) {
                window.videoAnalyzer.startAnalysis(2); // Analyze every 2 seconds
            } else {
                alert('Video analyzer not loaded. Make sure video_analysis.js is included.');
            }
        };
        
        document.getElementById('stopAnalysisBtn').onclick = function() {
            if (window.videoAnalyzer) {
                window.videoAnalyzer.stopAnalysis();
            }
        };
        
        document.getElementById('summaryBtn').onclick = function() {
            if (window.videoAnalyzer) {
                window.videoAnalyzer.getAnalysisSummary();
            }
        };
    </script>
    <!-- Add video analysis script -->
    <script src="video_analysis.js"></script>
    
    <!-- Chatbot functionality -->
    <script>
        class LegalAssistant {
            constructor() {
                this.messagesContainer = document.getElementById('chatbotMessages');
                this.input = document.getElementById('chatbotInput');
                this.sendBtn = document.getElementById('chatbotSendBtn');
                this.judgeMessages = [];
                this.conversationHistory = [];
                
                this.initializeEventListeners();
                this.startMonitoringJudgeMessages();
            }
            
            initializeEventListeners() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            startMonitoringJudgeMessages() {
                // Monitor for judge messages by checking the judge.js module
                setInterval(() => {
                    this.analyzeConversation();
                }, 3000);
            }
            
            addMessage(content, type = 'message') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbot-message ${type}`;
                messageDiv.textContent = content;
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
            
            sendMessage() {
                const message = this.input.value.trim();
                if (!message) return;
                
                this.addMessage(`You: ${message}`, 'message');
                this.input.value = '';
                
                // Simulate AI response based on context
                setTimeout(() => {
                    const response = this.generateResponse(message);
                    this.addMessage(response, 'suggestion');
                }, 1000);
            }
            
            analyzeConversation() {
                // This would integrate with the actual judge conversation
                // For now, we'll simulate analysis
                const currentTime = new Date();
                const shouldAnalyze = Math.random() > 0.7; // 30% chance every 3 seconds
                
                if (shouldAnalyze) {
                    const suggestions = this.getContextualSuggestions();
                    if (suggestions.length > 0) {
                        suggestions.forEach(suggestion => {
                            this.addMessage(suggestion, 'suggestion');
                        });
                    }
                }
            }
            
            getContextualSuggestions() {
                const suggestions = [
                    "üí° Consider asking for clarification on the legal precedent mentioned",
                    "‚ö†Ô∏è The judge seems to be focusing on procedural matters - prepare your evidence accordingly",
                    "‚úÖ Good opportunity to present your strongest argument now",
                    "üìã Consider requesting a brief recess to consult with your client",
                    "üéØ The judge appears receptive - this is a good time to make your key point",
                    "‚öñÔ∏è Be prepared to address the constitutional implications if raised",
                    "üìù Consider objecting if the opposing counsel makes hearsay statements",
                    "üîç Ask for specific case law references to strengthen your position"
                ];
                
                // Return 1-2 random suggestions
                const numSuggestions = Math.floor(Math.random() * 2) + 1;
                return suggestions.sort(() => 0.5 - Math.random()).slice(0, numSuggestions);
            }
            
            generateResponse(userMessage) {
                const lowerMessage = userMessage.toLowerCase();
                
                if (lowerMessage.includes('objection') || lowerMessage.includes('object')) {
                    return "Objection! Consider the following grounds: relevance, hearsay, speculation, or leading questions. Be specific about your objection.";
                } else if (lowerMessage.includes('evidence') || lowerMessage.includes('proof')) {
                    return "When presenting evidence, ensure it's properly authenticated, relevant, and not hearsay. Consider the chain of custody for physical evidence.";
                } else if (lowerMessage.includes('witness') || lowerMessage.includes('testimony')) {
                    return "For witness testimony, establish credibility first, then move to substantive questions. Avoid leading questions on direct examination.";
                } else if (lowerMessage.includes('motion') || lowerMessage.includes('request')) {
                    return "When making motions, be specific about the relief sought and cite relevant legal authority. Prepare for potential opposition arguments.";
                } else if (lowerMessage.includes('closing') || lowerMessage.includes('argument')) {
                    return "In closing arguments, summarize key evidence, address weaknesses in your case, and connect facts to legal standards.";
                } else {
                    return "I'm analyzing the current proceedings. Based on the context, consider focusing on the legal standards and factual elements that support your position.";
                }
            }
            
            // Method to be called when judge or counsellor messages are detected
            onJudgeMessage(message, speaker = 'judge') {
                this.judgeMessages.push({
                    content: message,
                    speaker: speaker,
                    timestamp: new Date()
                });
                
                // Analyze the message and provide suggestions
                this.analyzeMessage(message, speaker);
            }
            
            analyzeMessage(message, speaker) {
                const lowerMessage = message.toLowerCase();
                const speakerName = speaker === 'judge' ? 'Judge' : 'Opposing Counsel';
                
                if (lowerMessage.includes('objection') || lowerMessage.includes('sustained') || lowerMessage.includes('overruled')) {
                    if (speaker === 'judge') {
                        this.addMessage("‚öñÔ∏è The judge ruled on an objection. Note the ruling for your case strategy.", 'warning');
                    } else {
                        this.addMessage("‚ö†Ô∏è Opposing counsel made an objection. Be prepared to respond with your argument.", 'warning');
                    }
                } else if (lowerMessage.includes('evidence') || lowerMessage.includes('exhibit')) {
                    if (speaker === 'judge') {
                        this.addMessage("üìã Judge is discussing evidence. Ensure all your evidence is properly authenticated and relevant.", 'suggestion');
                    } else {
                        this.addMessage("üìã Opposing counsel is presenting evidence. Consider objecting if it's inadmissible or prepare counter-evidence.", 'suggestion');
                    }
                } else if (lowerMessage.includes('witness') || lowerMessage.includes('testimony')) {
                    if (speaker === 'judge') {
                        this.addMessage("üë§ Judge is questioning witness testimony. Prepare cross-examination questions if needed.", 'suggestion');
                    } else {
                        this.addMessage("üë§ Opposing counsel is examining witness. Listen for inconsistencies and prepare cross-examination.", 'suggestion');
                    }
                } else if (lowerMessage.includes('motion') || lowerMessage.includes('request')) {
                    if (speaker === 'judge') {
                        this.addMessage("üìù Judge is considering a motion. Prepare your response and any counter-arguments.", 'suggestion');
                    } else {
                        this.addMessage("üìù Opposing counsel made a motion. Consider objecting and prepare your counter-argument.", 'suggestion');
                    }
                } else if (lowerMessage.includes('recess') || lowerMessage.includes('break')) {
                    this.addMessage("‚è∞ Court is taking a recess. Use this time to prepare your next arguments.", 'message');
                } else if (lowerMessage.includes('guilty') || lowerMessage.includes('not guilty')) {
                    this.addMessage("üéØ Verdict discussion is happening. This is a critical moment - ensure your strongest arguments are clear.", 'warning');
                } else if (lowerMessage.includes('constitutional') || lowerMessage.includes('constitution')) {
                    this.addMessage("‚öñÔ∏è Constitutional issues are being raised. Be prepared to address constitutional implications.", 'suggestion');
                } else if (lowerMessage.includes('precedent') || lowerMessage.includes('case law')) {
                    this.addMessage("üìö Legal precedent is being discussed. Have your case law references ready.", 'suggestion');
                } else if (lowerMessage.includes('burden of proof') || lowerMessage.includes('standard of proof')) {
                    this.addMessage("‚öñÔ∏è Burden of proof is being discussed. Ensure you understand who has the burden and what standard applies.", 'suggestion');
                }
            }
        }
        
        // Initialize the legal assistant when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.legalAssistant = new LegalAssistant();
        });
        
        // Function to be called from judge.js when messages are received
        function onJudgeMessageReceived(message) {
            if (window.legalAssistant) {
                window.legalAssistant.onJudgeMessage(message);
            }
        }
    </script>
     
</body>
</html>